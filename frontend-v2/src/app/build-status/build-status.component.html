<chaotic-title title="Build status" subtitle="Currently running pipelines and build queue"> </chaotic-title>

<div class="chaotic-container-wide-center md:chaotic-container-regular">
  <chaotic-pipelines></chaotic-pipelines>
  @if (isWide) {
    <div class="flex">
      <p-card header="Pipelines">
        <div class="mt-5">
          <p-timeline [value]="pipelines">
            <ng-template #opposite let-unTypedPipeline>
              <ng-container *ngIf="typed(unTypedPipeline) as pipeline">
                <small class="text-surface-500 dark:text-surface-400">{{ pipeline.created_at | date: 'short' }}</small>
              </ng-container>
            </ng-template>
            <ng-template #content let-unTypedPipeline>
              <ng-container *ngIf="typed(unTypedPipeline) as pipeline">
                <i
                  class="pi"
                  [ngClass]="{
                    'pi-check-circle text-green-500': pipeline.status === 'success',
                    'pi-ban text-orange-500': pipeline.status === 'canceled',
                    'pi-exclamation-circle text-red-500': pipeline.status === 'failed',
                    'pi-angle-double-right text-gray-500': pipeline.status === 'skipped',
                    'pi-spin pi-spinner text-orange-200': pipeline.status === 'running',
                  }"
                ></i>
                <span class="ml-1">
                  <a [href]="pipeline.web_url">{{ pipeline.status }}</a>
                </span>
              </ng-container>
            </ng-template>
          </p-timeline>
        </div>
      </p-card>
      <div class="mx-auto">
        @if (activeQueue.length > 0) {
          <div>
            <p-card [style]="{ width: '30rem', overflow: 'hidden' }">
              <ng-template #header>
                <img alt="Card" class="w-full" src="https://primefaces.org/cdn/primeng/images/card-ng.jpg" />
              </ng-template>
              <ng-template #title>Active builds</ng-template>
              <ng-template #subtitle>These are currently ongoing builds</ng-template>
              <p-table [value]="activeQueue" [tableStyle]="{ 'min-width': '15rem' }">
                <ng-template #header>
                  <tr>
                    <th>Name</th>
                    <th>Node</th>
                    <th>Build class</th>
                    <th>Live log</th>
                  </tr>
                </ng-template>
                <ng-template #body let-pkg>
                  <tr>
                    <td>{{ pkg.name }}</td>
                    <td>{{ pkg.node }}</td>
                    <td>{{ pkg.build_class | buildClass }}</td>
                    <td>
                      <a href="{{ pkg.liveLogUrl }}">click <i class="pi pi-external-link"></i> </a>
                    </td>
                  </tr>
                </ng-template>
              </p-table>

              <ng-template #footer>
                <div class="mt-1 flex gap-4"></div>
              </ng-template>
            </p-card>
          </div>
        }
        @if (waitingQueue.length > 0) {
          <div
            [ngClass]="{
              'mt-5': activeQueue.length > 0,
            }"
          >
            <p-card [style]="{ width: '30rem', overflow: 'hidden' }">
              <ng-template #header>
                <img alt="Card" class="w-full" src="https://primefaces.org/cdn/primeng/images/card-ng.jpg" />
              </ng-template>
              <ng-template #title>Waiting builds</ng-template>
              <ng-template #subtitle>These are currently queued builds</ng-template>
              <p-table [value]="waitingQueue" [tableStyle]="{ 'min-width': '15rem' }">
                <ng-template #header>
                  <tr>
                    <th>Name</th>
                    <th>Build class</th>
                  </tr>
                </ng-template>
                <ng-template #body let-pkg>
                  <tr>
                    <td>{{ pkg.name }}</td>
                    <td>{{ pkg.build_class | buildClass }}</td>
                  </tr>
                </ng-template>
              </p-table>
              <ng-template #footer>
                <div class="mt-1 flex gap-4"></div>
              </ng-template>
            </p-card>
          </div>
        }
        @if (idleQueue.length > 0) {
          <div
            [ngClass]="{
              'mt-5': activeQueue.length > 0 || waitingQueue.length > 0,
            }"
          >
            <p-card [style]="{ width: '30rem', overflow: 'hidden' }">
              <ng-template #header>
                <img
                  alt="Card"
                  class="w-full"
                  src="https://image1.masterfile.com/getImage/NjEwOS0wODM4OTk0OWVuLjAwMDAwMDAw=ALtEiA/6109-08389949en_Masterfile.jpg"
                />
              </ng-template>
              <ng-template #title>Idle builders</ng-template>
              <ng-template #subtitle>Currently idle builders</ng-template>
              <p-table [value]="idleQueue" [tableStyle]="{ 'min-width': '15rem' }">
                <ng-template #header>
                  <tr>
                    <th>Name</th>
                    <th>Build class</th>
                  </tr>
                </ng-template>
                <ng-template #body let-pkg>
                  <tr>
                    <td>{{ pkg.name }}</td>
                    <td>{{ pkg.build_class | buildClass }}</td>
                  </tr>
                </ng-template>
              </p-table>
              <ng-template #footer>
                <div class="mt-1 flex gap-4"></div>
              </ng-template>
            </p-card>
          </div>
        }
      </div>
      <p-card header="Latest deployments">
        <div class="mt-5">
          <p-timeline [value]="latestDeployments">
            <ng-template #opposite let-untypedDeployment>
              <ng-container *ngIf="typedDeployment(untypedDeployment) as deployment">
                <small class="text-surface-500 dark:text-surface-400">{{ deployment.timestamp | date: 'short' }}</small>
              </ng-container>
            </ng-template>
            <ng-template #content let-untypedDeployment>
              <ng-container *ngIf="typedDeployment(untypedDeployment) as deployment">
                <span>
                  <a [href]="deployment.logUrl">{{ deployment.pkgbase.pkgname }}</a
                  ><br />
                  <a class="text-sm">({{ deployment.repo?.name }})</a>
                </span>
              </ng-container>
            </ng-template>
          </p-timeline>
        </div>
      </p-card>
    </div>
  } @else {
    <p-tabs [ngClass]="{ rounded: true }" value="0">
      <p-tablist>
        <p-tab value="0">Queue status</p-tab>
        <p-tab value="1">Pipelines</p-tab>
        <p-tab value="2">Deployments</p-tab>
      </p-tablist>
      <p-tabpanels>
        <p-tabpanel value="0">
          <div class="chaotic-tab-content">
            @if (activeQueue.length > 0) {
              <div style="margin-top: 2.5rem">
                <p-card [style]="{ width: '100%', overflow: 'hidden' }">
                  <ng-template #header>
                    <img alt="Card" class="w-full" src="https://primefaces.org/cdn/primeng/images/card-ng.jpg" />
                  </ng-template>
                  <ng-template #title>Active builds</ng-template>
                  <ng-template #subtitle>These are currently ongoing builds</ng-template>
                  <p-table [value]="activeQueue" [tableStyle]="{ 'min-width': '15rem' }">
                    <ng-template #header>
                      <tr>
                        <th>Name</th>
                        <th>Node</th>
                        <th>Build class</th>
                        <th>Live log</th>
                      </tr>
                    </ng-template>
                    <ng-template #body let-pkg>
                      <tr>
                        <td>{{ pkg.name }}</td>
                        <td>{{ pkg.node }}</td>
                        <td>{{ pkg.build_class | buildClass }}</td>
                        <td>
                          <a href="{{ pkg.liveLogUrl }}">click <i class="pi pi-external-link"></i> </a>
                        </td>
                      </tr>
                    </ng-template>
                  </p-table>

                  <ng-template #footer>
                    <div class="mt-1 flex gap-4"></div>
                  </ng-template>
                </p-card>
              </div>
            }
            @if (waitingQueue.length > 0) {
              <div style="margin-top: 2.5rem">
                <p-card [style]="{ width: '100%', overflow: 'hidden' }">
                  <ng-template #header>
                    <img alt="Card" class="w-full" src="https://primefaces.org/cdn/primeng/images/card-ng.jpg" />
                  </ng-template>
                  <ng-template #title>Waiting builds</ng-template>
                  <ng-template #subtitle>These are currently queued builds</ng-template>
                  <p-table [value]="waitingQueue" [tableStyle]="{ 'min-width': '15rem' }">
                    <ng-template #header>
                      <tr>
                        <th>Name</th>
                        <th>Build class</th>
                      </tr>
                    </ng-template>
                    <ng-template #body let-pkg>
                      <tr>
                        <td>{{ pkg.name }}</td>
                        <td>{{ pkg.build_class | buildClass }}</td>
                      </tr>
                    </ng-template>
                  </p-table>
                  <ng-template #footer>
                    <div class="mt-1 flex gap-4"></div>
                  </ng-template>
                </p-card>
              </div>
            }
            @if (idleQueue.length > 0) {
              <div style="margin-top: 2.5rem">
                <p-card [style]="{ width: '100%', overflow: 'hidden' }">
                  <ng-template #header>
                    <img
                      alt="Card"
                      class="w-full"
                      src="https://image1.masterfile.com/getImage/NjEwOS0wODM4OTk0OWVuLjAwMDAwMDAw=ALtEiA/6109-08389949en_Masterfile.jpg"
                    />
                  </ng-template>
                  <ng-template #title>Idle builders</ng-template>
                  <ng-template #subtitle>Currently idle builders</ng-template>
                  <p-table [value]="idleQueue" [tableStyle]="{ 'min-width': '15rem' }">
                    <ng-template #header>
                      <tr>
                        <th>Name</th>
                        <th>Build class</th>
                      </tr>
                    </ng-template>
                    <ng-template #body let-pkg>
                      <tr>
                        <td>{{ pkg.name }}</td>
                        <td>{{ pkg.build_class | buildClass }}</td>
                      </tr>
                    </ng-template>
                  </p-table>
                  <ng-template #footer>
                    <div class="mt-1 flex gap-4"></div>
                  </ng-template>
                </p-card>
              </div>
            }
          </div>
        </p-tabpanel>
        <p-tabpanel value="1">
          <div class="chaotic-tab-content">
            <p-timeline [value]="pipelines">
              <ng-template #opposite let-unTypedPipeline>
                <ng-container *ngIf="typed(unTypedPipeline) as pipeline">
                  <small class="text-surface-500 dark:text-surface-400">{{
                    pipeline.created_at | date: 'short'
                  }}</small>
                </ng-container>
              </ng-template>
              <ng-template #content let-unTypedPipeline>
                <ng-container *ngIf="typed(unTypedPipeline) as pipeline">
                  <i
                    class="pi"
                    [ngClass]="{
                      'pi-check-circle text-green-500': pipeline.status === 'success',
                      'pi-ban text-orange-500': pipeline.status === 'canceled',
                      'pi-exclamation-circle text-red-500': pipeline.status === 'failed',
                      'pi-angle-double-right text-gray-500': pipeline.status === 'skipped',
                      'pi-spin pi-spinner text-orange-200': pipeline.status === 'running',
                    }"
                  ></i>
                  <span class="ml-1">
                    <a [href]="pipeline.web_url">{{ pipeline.status }}</a>
                  </span>
                </ng-container>
              </ng-template>
            </p-timeline>
          </div>
        </p-tabpanel>
        <p-tabpanel value="2">
          <div class="chaotic-tab-content">
            <p-timeline [value]="latestDeployments">
              <ng-template #opposite let-untypedDeployment>
                <ng-container *ngIf="typedDeployment(untypedDeployment) as deployment">
                  <small class="text-surface-500 dark:text-surface-400">{{
                    deployment.timestamp | date: 'short'
                  }}</small>
                </ng-container>
              </ng-template>
              <ng-template #content let-untypedDeployment>
                <ng-container *ngIf="typedDeployment(untypedDeployment) as deployment">
                  <span>
                    <a [href]="deployment.logUrl">{{ deployment.pkgbase.pkgname }}</a
                    ><br />
                    <a class="text-sm">({{ deployment.repo?.name }})</a>
                  </span>
                </ng-container>
              </ng-template>
            </p-timeline>
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  }
</div>
