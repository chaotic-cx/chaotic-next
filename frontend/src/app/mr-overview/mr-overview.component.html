<chaotic-title
  title="Update review"
  subtitleHtml="Package updates currently queued for human review with the option to approve the MR for auto-merge."
></chaotic-title>

@if (mrOverviewService.token() !== '' && mrOverviewService.isLoading()) {
  <div class="flex justify-center my-10">
    <p-progress-spinner ariaLabel="loading" />
  </div>
} @else {
  @if (mrOverviewService.token() === '') {
    <div class="flex flex-col gap-2 text-ctp-text text-center mb-10">
      <label for="username">GitLab Access Token</label>
      <input
        class="w-10/12 sm:w-1/2 mx-auto"
        id="token_input"
        #tokenInput
        [pAutoFocus]="true"
        [value]="mrOverviewService.token()"
        (keydown.enter)="setToken(tokenInput.value)"
        type="password"
        pInputText
      />
      <small class="mx-auto px-10" id="username-help">
        As a maintainer, you can create a personal access token in your GitLab account settings.
      </small>
      <p-select-button
        class="mx-auto mt-2 px-10"
        [(ngModel)]="mrOverviewService.storage"
        [options]="storages"
        aria-labelledby="token-storage"
        optionValue="value"
        optionLabel="label"
      >
      </p-select-button>
    </div>
  }
  <div class="chaotic-container-wide-center md:chaotic-container-regular p-0.5 sm:p-2.5">
    @if (mrOverviewService.mergeRequests().length === 0) {
      <p class="text-ctp-text text-center">No open merge requests found.</p>
      <a class="text-ctp-mauve" href="https://gitlab.com/chaotic-aur/pkgbuilds/-/merge_requests"
        >You can also browse all merge requests on GitLab.
      </a>
      <p>
        <i class="text-ctp-maroon pi pi-verified mt-10" style="font-size: 5rem"></i>
      </p>
    } @else {
      @for (mr of mrOverviewService.mergeRequests(); track mr.id; let i = $index) {
        <p-panel class="mr-overview-panel" [ngClass]="i > 0 ? 'mt-5' : ''">
          <ng-template #header>
            <a class="cursor-pointer text-ctp-mauve" [href]="mr.web_url">{{
              mr.title + (mr.labels.includes('hold') ? ' [ON HOLD]' : '')
            }}</a>
          </ng-template>

          @if (mr.diffs && mr.diffs.length > 0) {
            @for (change of mr.diffs; track change.new_path) {
              <p-fieldset
                class="text-left fieldset-responsive overflow-x-auto block mb-5"
                [legend]="change.new_path.replace(mr.title + '/', '')"
                [toggleable]="true"
                [collapsed]="mrOverviewService.token() === ''"
              >
                <chaotic-diff-renderer class="overflow-x-auto" [diff]="change.diff" />
              </p-fieldset>
            }
          } @else {
            <span class="text-ctp-text">No changes</span>
          }

          @if (mrOverviewService.token() !== '') {
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
              <div class="w-full min-w-0">
                <p-button
                  [disabled]="mr.labels.includes('approved') || mr.labels.includes('dangerous')"
                  [label]="mr.labels.includes('approved') ? 'Already approved' : 'Approve update'"
                  [loading]="isLoading(mr, 'approve')"
                  (onClick)="mrOverviewService.approve(mr)"
                  icon="pi pi-check"
                  severity="success"
                  styleClass="w-50"
                ></p-button>
              </div>

              <div class="w-full min-w-0">
                <p-button
                  [disabled]="
                    mr.labels.includes('dangerous') || mr.labels.includes('approved') || mr.labels.includes('hold')
                  "
                  [label]="mr.labels.includes('dangerous') ? 'Already flagged' : 'Flag as dangerous'"
                  [loading]="isLoading(mr, 'flag')"
                  (onClick)="mrOverviewService.flagDangerous(mr)"
                  icon="pi pi-exclamation-triangle"
                  severity="danger"
                  styleClass="w-50"
                ></p-button>
              </div>

              <div class="w-full min-w-0">
                <p-button
                  [disabled]="
                    mr.labels.includes('hold') || mr.labels.includes('dangerous') || mr.labels.includes('approved')
                  "
                  [label]="mr.labels.includes('hold') ? 'Already on hold' : 'Hold for now'"
                  [loading]="isLoading(mr, 'flag')"
                  (onClick)="mrOverviewService.flagHold(mr)"
                  icon="pi pi-pause"
                  severity="warn"
                  styleClass="w-50"
                ></p-button>
              </div>
            </div>
          }
        </p-panel>
      }
    }
  </div>

  @if (mrOverviewService.token() !== '') {
    <div class="flex justify-center mt-10">
      <p-button (onClick)="openDialog()" label="Manage Packages" icon="pi pi-box" severity="secondary"></p-button>
    </div>
  }
}

<p-dialog [(visible)]="dialogVisible" header="Bump Packages" modal="true" styleClass="w-11/12 md:w-3/4">
  <div class="flex flex-col gap-4">
    <div>
      <label for="packages">Select Packages</label>
      <p-multi-select
        class="w-full"
        id="packages"
        [(ngModel)]="selectedPackages"
        [options]="filteredOptions()"
        [filter]="true"
        optionLabel="label"
        appendTo="body"
        optionValue="value"
        placeholder="Select packages to bump"
        display="chip"
      ></p-multi-select>
    </div>
    <div class="flex gap-2 justify-end">
      <p-button
        [disabled]="selectedPackages().length === 0"
        (onClick)="bump()"
        label="Bump"
        severity="success"
      ></p-button>
      <p-button
        [disabled]="selectedPackages().length === 0"
        (onClick)="schedule()"
        label="Schedule"
        severity="info"
      ></p-button>
    </div>
  </div>
</p-dialog>
