<chaotic-title
  title="Update review"
  subtitleHtml="Currently open merge requests with package update diff and the option to approve the MR for auto-merge."
></chaotic-title>

@if (mrOverviewService.token() !== '' && mrOverviewService.isLoading()) {
  <div class="flex justify-center my-10">
    <p-progress-spinner ariaLabel="loading" />
  </div>
} @else {
  @if (mrOverviewService.token() === '') {
    <div class="flex flex-col gap-2 text-ctp-text text-center mb-10">
      <label for="username">GitLab Access Token</label>
      <input
        class="w-10/12 sm:w-1/2 mx-auto"
        id="token_input"
        #tokenInput
        [pAutoFocus]="true"
        [value]="mrOverviewService.token()"
        (keydown.enter)="setToken(tokenInput.value)"
        type="password"
        pInputText
      />
      <small class="mx-auto px-10" id="username-help">
        You can create a personal access token in your GitLab account settings. It needs the "api" scope. Make sure to
        keep it secret and do not share it with anyone.
      </small>
      <p-select-button
        class="mx-auto mt-2 px-10"
        [(ngModel)]="mrOverviewService.storage"
        [options]="storages"
        aria-labelledby="token-storage"
        optionValue="value"
        optionLabel="label"
      >
      </p-select-button>
    </div>
  } @else {
    <div class="chaotic-container-wide-center md:chaotic-container-regular p-2.5">
      @for (mr of mrOverviewService.mergeQuests(); track mr.id) {
        <p-panel [header]="mr.title">
          @if (mr.changes && mr.changes.length > 0) {
            @for (change of mr.changes; track change.new_path) {
              <p-fieldset
                class="text-left fieldset-responsive overflow-x-auto block mb-5"
                [legend]="change.new_path.replace(mr.title + '/', '')"
                [toggleable]="true"
              >
                <chaotic-diff-renderer class="overflow-x-auto" [diff]="change.diff" />
              </p-fieldset>
            }
          } @else {
            <span class="text-ctp-text">No changes</span>
          }

          <p-button
            [disabled]="mr.labels.includes('approved')"
            [label]="mr.labels.includes('approved') ? 'Already approved' : 'Approve Merge Request'"
            [loading]="isApproving(mr)"
            (onClick)="mrOverviewService.approve(mr)"
            icon="pi pi-check"
          />
        </p-panel>
      }
    </div>
  }
}
